<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>aOa Dashboard</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ====== @property for gradient angle ====== */
@property --gradient-angle {
  syntax: '<angle>';
  initial-value: 0deg;
  inherits: false;
}

/* ====== CSS VARIABLES ====== */
[data-theme="dark"] {
  --bg: #0c0c0e;
  --card: #161618;
  --card-hover: #1c1c1f;
  --border: #252528;
  --border-subtle: #1e1e21;
  --text: #e8e8ec;
  --text-secondary: #c4c4cc;
  --dim: #8b8b96;
  --mute: #55555f;
  --green: #34d399;
  --green-dim: rgba(52,211,153,0.12);
  --blue: #60a5fa;
  --blue-dim: rgba(96,165,250,0.12);
  --purple: #c084fc;
  --purple-dim: rgba(192,132,252,0.12);
  --cyan: #22d3ee;
  --cyan-dim: rgba(34,211,238,0.12);
  --yellow: #fbbf24;
  --yellow-dim: rgba(251,191,36,0.12);
  --red: #f87171;
  --shadow: none;
  --nav-bg: rgba(12,12,14,0.82);
  --table-hover: rgba(255,255,255,0.03);
}

[data-theme="light"] {
  --bg: #f5f5f7;
  --card: #ffffff;
  --card-hover: #fafafa;
  --border: #e5e5ea;
  --border-subtle: #ececee;
  --text: #1d1d1f;
  --text-secondary: #3a3a3c;
  --dim: #6e6e73;
  --mute: #aeaeb2;
  --green: #16a34a;
  --blue: #2563eb;
  --purple: #9333ea;
  --cyan: #0891b2;
  --yellow: #d97706;
  --red: #dc2626;
  --shadow: 0 1px 3px rgba(0,0,0,0.06);
  --nav-bg: rgba(245,245,247,0.82);
  --table-hover: rgba(0,0,0,0.02);
  --green-dim: rgba(22,163,74,0.1);
  --blue-dim: rgba(37,99,235,0.1);
  --purple-dim: rgba(147,51,234,0.1);
  --cyan-dim: rgba(8,145,178,0.1);
  --yellow-dim: rgba(217,119,6,0.1);
}

/* ====== RESET & BODY ====== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  height: 100vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  font-size: 14px;
  line-height: 1.5;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.mono {
  font-family: 'JetBrains Mono', 'SF Mono', 'Cascadia Code', 'Fira Code', monospace;
}

.tabnum {
  font-variant-numeric: tabular-nums;
}

/* ====== ANIMATIONS ====== */
@keyframes value-pulse {
  0% { color: var(--green); }
  100% { color: inherit; }
}

.pulse {
  animation: value-pulse 0.5s ease-out;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

@keyframes gradient-rotate {
  0% { --gradient-angle: 0deg; }
  100% { --gradient-angle: 360deg; }
}

@keyframes fade-in {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ====== NAV ====== */
.nav {
  height: 52px;
  flex-shrink: 0;
  position: sticky;
  top: 0;
  z-index: 100;
  background: var(--nav-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.nav-left {
  display: flex;
  align-items: center;
  gap: 8px;
}

.nav-brand {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-right: 20px;
}

.nav-brand .angle {
  font-size: 22px;
  color: var(--green);
  font-weight: 700;
  line-height: 1;
}

.nav-brand .name {
  font-size: 16px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: 0.5px;
}

.nav-tabs {
  display: flex;
  gap: 4px;
}

.nav-tab {
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 500;
  color: var(--dim);
  cursor: pointer;
  transition: color 0.15s;
  user-select: none;
  border: none;
  background: none;
  position: relative;
}

.nav-tab:hover {
  color: var(--text-secondary);
}

.nav-tab.active {
  color: var(--green);
}

.nav-tab.active::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 8px;
  right: 8px;
  height: 2px;
  background: var(--green);
  border-radius: 1px;
}

.nav-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.status-badge {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  font-weight: 600;
  padding: 4px 12px;
  border-radius: 20px;
}

.status-badge .dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-badge.connected {
  background: var(--green-dim);
  color: var(--green);
}

.status-badge.connected .dot {
  background: var(--green);
  animation: blink 2s ease-in-out infinite;
}

.status-badge.disconnected {
  background: rgba(248,113,113,0.12);
  color: var(--red);
}

.status-badge.disconnected .dot {
  background: var(--red);
}

.status-badge.mock {
  background: var(--yellow-dim);
  color: var(--yellow);
}

.status-badge.mock .dot {
  background: var(--yellow);
  animation: blink 2s ease-in-out infinite;
}

.theme-toggle {
  width: 34px;
  height: 34px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: var(--card);
  cursor: pointer;
  color: var(--dim);
  transition: all 0.15s;
}

.theme-toggle:hover {
  border-color: var(--mute);
  color: var(--text);
}

.theme-toggle svg {
  width: 16px;
  height: 16px;
}

/* ====== MAIN CONTENT ====== */
.main {
  flex: 1;
  overflow: hidden;
}

.tab-content {
  display: none;
  height: 100%;
}

.tab-content.active {
  display: flex;
  flex-direction: column;
}

/* ====== DISCONNECTED BANNER ====== */
.disconnected-banner {
  display: none;
  padding: 8px 24px;
  background: rgba(248,113,113,0.08);
  border-bottom: 1px solid rgba(248,113,113,0.2);
  color: var(--red);
  text-align: center;
  font-size: 12px;
  font-weight: 500;
  flex-shrink: 0;
}

.disconnected-banner.show {
  display: block;
}

/* ====== CARDS ====== */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  box-shadow: var(--shadow);
}

.card-accent {
  position: relative;
}

.card-accent::before {
  content: '';
  position: absolute;
  top: 0;
  left: 16px;
  right: 16px;
  height: 2px;
  border-radius: 0 0 2px 2px;
}

.card-accent.accent-cyan::before { background: var(--cyan); }
.card-accent.accent-green::before { background: var(--green); }
.card-accent.accent-purple::before { background: var(--purple); }
.card-accent.accent-yellow::before { background: var(--yellow); }
.card-accent.accent-blue::before { background: var(--blue); }
.card-accent.accent-red::before { background: var(--red); }

/* ====== HERO CARD (gradient border) ====== */
.hero-card {
  position: relative;
  background: var(--card);
  border-radius: 16px;
  padding: 24px;
  box-shadow: var(--shadow);
  overflow: hidden;
}

.hero-card::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 16px;
  padding: 1px;
  background: conic-gradient(from var(--gradient-angle, 0deg), var(--green), var(--blue), var(--purple), var(--green));
  -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite: xor;
  mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  mask-composite: exclude;
  animation: gradient-rotate 6s linear infinite;
  pointer-events: none;
}

.hero-label {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--mute);
  font-family: 'JetBrains Mono', monospace;
  margin-bottom: 8px;
}

.hero-headline {
  font-size: 24px;
  font-weight: 700;
  line-height: 1.3;
  background: linear-gradient(135deg, var(--text) 0%, var(--green) 50%, var(--blue) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 10px;
}

.hero-narrative {
  font-size: 14px;
  color: var(--dim);
  line-height: 1.6;
}

.hero-narrative .n-green { color: var(--green); font-weight: 600; font-variant-numeric: tabular-nums; }
.hero-narrative .n-cyan { color: var(--cyan); font-weight: 600; font-variant-numeric: tabular-nums; }
.hero-narrative .n-blue { color: var(--blue); font-weight: 600; font-variant-numeric: tabular-nums; }

/* ====== METRICS PANEL ====== */
.metrics-panel {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.metrics-row {
  display: flex;
  gap: 20px;
}

.metric-big {
  flex: 1;
  text-align: center;
}

.metric-big .value {
  font-size: 36px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
  line-height: 1.1;
}

.metric-big .label {
  font-size: 11px;
  color: var(--dim);
  margin-top: 2px;
}

.autotune-section {
  width: 100%;
}

.autotune-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
}

.autotune-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--text-secondary);
}

.autotune-label .num {
  color: var(--yellow);
  font-variant-numeric: tabular-nums;
}

.autotune-track {
  width: 100%;
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}

.autotune-fill {
  height: 100%;
  background: var(--yellow);
  border-radius: 3px;
  transition: width 0.4s ease;
}

.autotune-sub {
  font-size: 11px;
  color: var(--mute);
  margin-top: 4px;
}

.uptime-chip {
  font-size: 11px;
  color: var(--mute);
  margin-top: 8px;
  text-align: center;
}

/* ====== MINI STAT CARDS ====== */
.stat-grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 12px;
}

.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow);
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 2px;
}

.stat-card.sc-cyan::before { background: var(--cyan); }
.stat-card.sc-green::before { background: var(--green); }
.stat-card.sc-purple::before { background: var(--purple); }
.stat-card.sc-yellow::before { background: var(--yellow); }
.stat-card.sc-blue::before { background: var(--blue); }
.stat-card.sc-red::before { background: var(--red); }

.stat-card .stat-value {
  font-size: 22px;
  font-weight: 700;
  font-variant-numeric: tabular-nums;
}

.stat-card .stat-label {
  font-size: 11px;
  color: var(--dim);
  margin-top: 2px;
}

.stat-card .stat-sub {
  font-size: 10px;
  color: var(--mute);
  margin-top: 1px;
}

/* ====== ACTIVITY CARD ====== */
.activity-card {
  flex: 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  box-shadow: var(--shadow);
  overflow: hidden;
}

.activity-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 20px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}

.activity-title {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--dim);
}

.badge {
  font-size: 10px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 10px;
}

.badge-live {
  background: var(--green-dim);
  color: var(--green);
}

.badge-soon {
  background: rgba(139,139,150,0.1);
  color: var(--mute);
}

.activity-body {
  flex: 1;
  overflow-y: auto;
  min-height: 0;
}

/* Activity table */
.activity-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

.activity-table thead {
  position: sticky;
  top: 0;
  z-index: 1;
}

.activity-table th {
  padding: 8px 16px;
  text-align: left;
  font-size: 10px;
  font-weight: 700;
  color: var(--mute);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
}

.activity-table td {
  padding: 8px 16px;
  border-bottom: 1px solid var(--border-subtle);
  font-variant-numeric: tabular-nums;
}

.activity-table tr:hover td {
  background: var(--table-hover);
}

.activity-table tr {
  animation: fade-in 0.3s ease-out;
}

.action-pill {
  display: inline-block;
  font-size: 10px;
  font-weight: 700;
  padding: 2px 8px;
  border-radius: 6px;
}

.pill-read { background: var(--green-dim); color: var(--green); }
.pill-search { background: var(--cyan-dim); color: var(--cyan); }
.pill-learn { background: var(--purple-dim); color: var(--purple); }

.impact-text { font-weight: 600; font-size: 11px; }
.impact-green { color: var(--green); }
.impact-cyan { color: var(--cyan); }
.impact-purple { color: var(--purple); }

.target-text {
  color: var(--dim);
  font-size: 11px;
  font-family: 'JetBrains Mono', monospace;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 300px;
}

.time-text {
  color: var(--mute);
  font-size: 11px;
}

.source-text {
  color: var(--dim);
  font-size: 11px;
}

.placeholder-msg {
  padding: 40px 20px;
  text-align: center;
  color: var(--mute);
  font-size: 13px;
  line-height: 1.6;
}

/* ====== OVERVIEW TAB LAYOUT ====== */
.overview-content {
  display: flex;
  flex-direction: column;
  height: 100%;
  padding: 16px 24px;
  gap: 14px;
}

.overview-hero-row {
  flex-shrink: 0;
  display: grid;
  grid-template-columns: 1fr 320px;
  gap: 14px;
}

.overview-stats-row {
  flex-shrink: 0;
}

.overview-activity-row {
  flex: 1;
  min-height: 0;
  display: flex;
}

/* ====== LEARNING TAB ====== */
.learning-content {
  height: 100%;
  overflow-y: auto;
  padding: 16px 24px;
}

.learning-stats {
  margin-bottom: 16px;
}

.learning-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 16px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
}

.card-title {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--dim);
}

.card-subtitle {
  font-size: 11px;
  color: var(--mute);
  margin-top: 2px;
}

/* Domain table */
.domain-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

.domain-table th {
  padding: 6px 12px;
  text-align: left;
  font-size: 10px;
  font-weight: 700;
  color: var(--mute);
  text-transform: uppercase;
  letter-spacing: 0.3px;
  border-bottom: 1px solid var(--border);
}

.domain-table th:nth-child(3) { text-align: right; }

.domain-table td {
  padding: 6px 12px;
  border-bottom: 1px solid var(--border-subtle);
  font-variant-numeric: tabular-nums;
}

.domain-table tr:hover td {
  background: var(--table-hover);
}

.d-rank { color: var(--mute); font-size: 10px; width: 28px; }
.d-name {
  font-family: 'JetBrains Mono', monospace;
  color: var(--purple);
  font-weight: 500;
  font-size: 12px;
}
.d-hits {
  text-align: right;
  font-family: 'JetBrains Mono', monospace;
  color: var(--green);
  font-weight: 600;
  font-variant-numeric: tabular-nums;
}
.d-tier { }

.tier-pill {
  display: inline-block;
  font-size: 10px;
  font-weight: 600;
  padding: 1px 8px;
  border-radius: 8px;
}

.tier-core { background: var(--green-dim); color: var(--green); }
.tier-ctx { background: rgba(139,139,150,0.08); color: var(--mute); }

.d-state { color: var(--dim); font-size: 11px; }

.domain-footer {
  padding: 12px;
  font-size: 11px;
  font-style: italic;
  color: var(--mute);
  border-top: 1px solid var(--border-subtle);
  text-align: center;
}

/* N-gram metrics */
.ngram-section {
  margin-bottom: 16px;
}

.ngram-section:last-child {
  margin-bottom: 0;
}

.ngram-section-title {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--mute);
  margin-bottom: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid var(--border-subtle);
}

.ngram-row {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 3px 0;
}

.ngram-name {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  color: var(--text-secondary);
  min-width: 120px;
  flex-shrink: 0;
}

.ngram-bar-track {
  flex: 1;
  height: 4px;
  background: var(--border);
  border-radius: 2px;
  overflow: hidden;
}

.ngram-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.4s ease;
}

.ngram-bar-fill.bar-cyan { background: var(--cyan); }
.ngram-bar-fill.bar-green { background: var(--green); }
.ngram-bar-fill.bar-purple { background: var(--purple); }

.ngram-count {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  font-weight: 600;
  font-variant-numeric: tabular-nums;
  color: var(--text-secondary);
  min-width: 32px;
  text-align: right;
}

.awaiting-data {
  padding: 30px 16px;
  text-align: center;
  color: var(--mute);
  font-size: 12px;
}

/* ====== CONVERSATION TAB ====== */
.conversation-content {
  height: 100%;
  overflow-y: auto;
  padding: 16px 24px;
}

.conversation-stats {
  margin-bottom: 16px;
}

.conv-stat-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
}

.conversation-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 16px;
}

.conv-placeholder-inner {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  text-align: center;
  color: var(--mute);
}

.conv-placeholder-inner svg {
  width: 40px;
  height: 40px;
  margin-bottom: 12px;
  opacity: 0.4;
}

.conv-placeholder-inner .ph-title {
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 4px;
  color: var(--dim);
}

.conv-placeholder-inner .ph-text {
  font-size: 12px;
}

/* ====== FOOTER ====== */
.footer {
  height: 32px;
  flex-shrink: 0;
  border-top: 1px solid var(--border);
  padding: 0 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 11px;
  color: var(--mute);
}

.footer-left {
  display: flex;
  align-items: center;
  gap: 6px;
}

.footer-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--green);
}

.footer-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.footer-motto {
  font-family: 'JetBrains Mono', monospace;
  font-size: 10px;
}

.footer-motto .way {
  color: var(--yellow);
  font-weight: 600;
}

.footer-clock {
  font-family: 'JetBrains Mono', monospace;
  font-variant-numeric: tabular-nums;
  font-size: 10px;
}

/* ====== SCROLLBAR ====== */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
::-webkit-scrollbar-thumb:hover { background: var(--mute); }

/* ====== RESPONSIVE ====== */
@media (max-width: 900px) {
  .stat-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  .conv-stat-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  .overview-hero-row {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 1000px) {
  .learning-grid {
    grid-template-columns: 1fr;
  }
  .conversation-grid {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 600px) {
  .stat-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .conv-stat-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}
</style>
</head>
<body>

<!-- ====== NAV ====== -->
<div class="nav">
  <div class="nav-left">
    <div class="nav-brand">
      <span class="angle">&ang;</span>
      <span class="name">aOa</span>
    </div>
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="overview">Overview</button>
      <button class="nav-tab" data-tab="learning">Learning</button>
      <button class="nav-tab" data-tab="conversation">Conversation</button>
    </div>
  </div>
  <div class="nav-right">
    <div class="status-badge connected" id="statusBadge">
      <span class="dot"></span>
      <span id="statusLabel">connected</span>
    </div>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
      <svg id="themeIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    </button>
  </div>
</div>

<!-- ====== DISCONNECTED BANNER ====== -->
<div class="disconnected-banner" id="discoBanner">Daemon unreachable â€” polling paused. Reconnecting...</div>

<!-- ====== MAIN ====== -->
<div class="main">

  <!-- ====== TAB: OVERVIEW ====== -->
  <div class="tab-content active" id="tab-overview">
    <div class="overview-content">

      <!-- Row 1: Hero -->
      <div class="overview-hero-row">
        <div class="hero-card">
          <div class="hero-label">ANGLE OF ATTACK</div>
          <div class="hero-headline">Agentic work, optimized to O(1).</div>
          <div class="hero-narrative">
            <span class="n-green" id="h-domains">&mdash;</span> domains discovered from
            <span class="n-cyan" id="h-prompts">&mdash;</span> prompts across
            <span class="n-blue" id="h-files">&mdash;</span> indexed files.
          </div>
        </div>
        <div class="card">
          <div class="metrics-panel">
            <div class="metrics-row">
              <div class="metric-big">
                <div class="value tabnum" id="m-prompts">&mdash;</div>
                <div class="label">prompts</div>
              </div>
              <div class="metric-big">
                <div class="value tabnum" style="color: var(--green)" id="m-domains">&mdash;</div>
                <div class="label">active</div>
              </div>
            </div>
            <div class="autotune-section">
              <div class="autotune-header">
                <span class="autotune-label">Autotune <span class="num" id="at-num">0</span>/50</span>
              </div>
              <div class="autotune-track">
                <div class="autotune-fill" id="at-fill" style="width: 0%"></div>
              </div>
              <div class="autotune-sub" id="at-sub">next cycle in 50</div>
            </div>
            <div class="uptime-chip">Up: <span id="s-uptime">&mdash;</span></div>
          </div>
        </div>
      </div>

      <!-- Row 2: Stats -->
      <div class="overview-stats-row">
        <div class="stat-grid">
          <div class="stat-card sc-cyan">
            <div class="stat-value tabnum" id="s-keywords">&mdash;</div>
            <div class="stat-label">Keywords</div>
          </div>
          <div class="stat-card sc-green">
            <div class="stat-value tabnum" id="s-terms">&mdash;</div>
            <div class="stat-label">Terms</div>
          </div>
          <div class="stat-card sc-purple">
            <div class="stat-value tabnum" id="s-bigrams">&mdash;</div>
            <div class="stat-label">Bigrams</div>
          </div>
          <div class="stat-card sc-yellow">
            <div class="stat-value tabnum" id="s-filehits">&mdash;</div>
            <div class="stat-label">File Hits</div>
          </div>
          <div class="stat-card sc-blue">
            <div class="stat-value tabnum" id="s-files">&mdash;</div>
            <div class="stat-label">Files Indexed</div>
          </div>
          <div class="stat-card sc-cyan">
            <div class="stat-value tabnum" id="s-tokens">&mdash;</div>
            <div class="stat-label">Tokens</div>
          </div>
        </div>
      </div>

      <!-- Row 3: Activity -->
      <div class="overview-activity-row">
        <div class="activity-card">
          <div class="activity-header">
            <span class="activity-title">Activity &amp; Impact</span>
            <span class="badge" id="activityBadge"></span>
          </div>
          <div class="activity-body" id="activityBody">
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ====== TAB: LEARNING ====== -->
  <div class="tab-content" id="tab-learning">
    <div class="learning-content">

      <!-- Row 1: Stats -->
      <div class="learning-stats">
        <div class="stat-grid">
          <div class="stat-card sc-purple">
            <div class="stat-value tabnum" id="l-domains">&mdash;</div>
            <div class="stat-label">Domains</div>
          </div>
          <div class="stat-card sc-green">
            <div class="stat-value tabnum" id="l-core">&mdash;</div>
            <div class="stat-label">Core</div>
          </div>
          <div class="stat-card sc-cyan">
            <div class="stat-value tabnum" id="l-terms">&mdash;</div>
            <div class="stat-label">Terms</div>
          </div>
          <div class="stat-card sc-blue">
            <div class="stat-value tabnum" id="l-keywords">&mdash;</div>
            <div class="stat-label">Keywords</div>
          </div>
          <div class="stat-card sc-yellow">
            <div class="stat-value tabnum" id="l-bigrams">&mdash;</div>
            <div class="stat-label">Bigrams</div>
          </div>
          <div class="stat-card sc-red">
            <div class="stat-value tabnum" id="l-hits">&mdash;</div>
            <div class="stat-label">Total Hits</div>
          </div>
        </div>
      </div>

      <!-- Row 2: Domains + Bigrams -->
      <div class="learning-grid">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Domain Rankings</div>
              <div class="card-subtitle">Sorted by learning signal strength</div>
            </div>
          </div>
          <div id="domainTableContainer">
            <div class="awaiting-data" id="domainPlaceholder">Awaiting domain data...</div>
          </div>
          <div class="domain-footer">aOa learns your workflow &rarr; Claude reads only what it needs.</div>
        </div>
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">N-gram Metrics</div>
              <div class="card-subtitle">Frequency patterns from session analysis</div>
            </div>
          </div>
          <div id="ngramContainer">
            <div class="awaiting-data" id="ngramPlaceholder">Awaiting bigram data...</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ====== TAB: CONVERSATION ====== -->
  <div class="tab-content" id="tab-conversation">
    <div class="conversation-content">

      <!-- Row 1: Stats -->
      <div class="conversation-stats">
        <div class="conv-stat-grid">
          <div class="stat-card sc-cyan">
            <div class="stat-value tabnum">&mdash;</div>
            <div class="stat-label">Input Today</div>
            <div class="stat-sub">coming soon</div>
          </div>
          <div class="stat-card sc-blue">
            <div class="stat-value tabnum">&mdash;</div>
            <div class="stat-label">Output Today</div>
            <div class="stat-sub">coming soon</div>
          </div>
          <div class="stat-card sc-green">
            <div class="stat-value tabnum">&mdash;</div>
            <div class="stat-label">Cache Read</div>
            <div class="stat-sub">coming soon</div>
          </div>
          <div class="stat-card sc-purple">
            <div class="stat-value tabnum">&mdash;</div>
            <div class="stat-label">Cache Write</div>
            <div class="stat-sub">coming soon</div>
          </div>
          <div class="stat-card sc-yellow">
            <div class="stat-value tabnum">&mdash;</div>
            <div class="stat-label">Cache Hit %</div>
            <div class="stat-sub">coming soon</div>
          </div>
        </div>
      </div>

      <!-- Row 2: Two-column placeholders -->
      <div class="conversation-grid">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Conversation Feed</div>
            <span class="badge badge-soon">coming soon</span>
          </div>
          <div class="conv-placeholder-inner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <div class="ph-title">Awaiting session data</div>
            <div class="ph-text">Live conversation feed will show user inputs and Claude responses.</div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Tools &amp; Agents</div>
            <span class="badge badge-soon">coming soon</span>
          </div>
          <div class="conv-placeholder-inner">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
            </svg>
            <div class="ph-title">Awaiting session data</div>
            <div class="ph-text">Tool usage timeline will show Read, Edit, Bash, Task calls with results.</div>
          </div>
        </div>
      </div>

      <!-- Row 3: Token Economics -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">Token Economics</div>
          <span class="badge badge-soon">coming soon</span>
        </div>
        <div class="conv-placeholder-inner">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="20" x2="12" y2="10"></line>
            <line x1="18" y1="20" x2="18" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="16"></line>
          </svg>
          <div class="ph-title">Awaiting session data</div>
          <div class="ph-text">Token usage breakdown by period and per-model velocity metrics.</div>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- ====== FOOTER ====== -->
<div class="footer">
  <div class="footer-left">
    <span class="footer-dot" id="footerDot"></span>
    <span>Online &middot; v1.0.0</span>
  </div>
  <div class="footer-right">
    <span class="footer-motto">aOa learns &rarr; you build faster. <span class="way">This is the way.</span></span>
    <span class="footer-clock" id="clock"></span>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ====== CONFIG ======
  var MOCK = new URLSearchParams(window.location.search).has('mock');
  var prev = {};
  var connected = false;
  var retryDelay = 2000;

  // ====== THEME ======
  var savedTheme = localStorage.getItem('aoa-theme');
  if (savedTheme) {
    document.documentElement.dataset.theme = savedTheme;
  }
  updateThemeIcon();

  document.getElementById('themeToggle').addEventListener('click', function() {
    var html = document.documentElement;
    var isDark = html.dataset.theme === 'dark';
    html.dataset.theme = isDark ? 'light' : 'dark';
    localStorage.setItem('aoa-theme', html.dataset.theme);
    updateThemeIcon();
  });

  function updateThemeIcon() {
    var isDark = document.documentElement.dataset.theme === 'dark';
    var icon = document.getElementById('themeIcon');
    if (isDark) {
      // Sun icon for dark mode (click to switch to light)
      icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle>' +
        '<line x1="12" y1="1" x2="12" y2="3"></line>' +
        '<line x1="12" y1="21" x2="12" y2="23"></line>' +
        '<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>' +
        '<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>' +
        '<line x1="1" y1="12" x2="3" y2="12"></line>' +
        '<line x1="21" y1="12" x2="23" y2="12"></line>' +
        '<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>' +
        '<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
    } else {
      // Moon icon for light mode (click to switch to dark)
      icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
    }
  }

  // ====== TAB SWITCHING ======
  var tabs = document.querySelectorAll('.nav-tab');
  var tabContents = document.querySelectorAll('.tab-content');

  tabs.forEach(function(tab) {
    tab.addEventListener('click', function() {
      tabs.forEach(function(t) { t.classList.remove('active'); });
      tabContents.forEach(function(tc) { tc.classList.remove('active'); });
      tab.classList.add('active');
      var target = document.getElementById('tab-' + tab.dataset.tab);
      if (target) target.classList.add('active');
    });
  });

  // ====== SET VALUE WITH PULSE ======
  function set(id, val) {
    var el = document.getElementById(id);
    if (!el) return;
    var str = String(val);
    if (el.textContent === str) return;
    var hadValue = prev[id] !== undefined && prev[id] !== '\u2014';
    el.textContent = str;
    if (hadValue) {
      el.classList.remove('pulse');
      void el.offsetWidth;
      el.classList.add('pulse');
    }
    prev[id] = str;
  }

  // ====== CONNECTION STATE ======
  function setConnected(ok) {
    connected = ok;
    var badge = document.getElementById('statusBadge');
    var label = document.getElementById('statusLabel');
    var banner = document.getElementById('discoBanner');
    var footerDot = document.getElementById('footerDot');

    if (MOCK) {
      badge.className = 'status-badge mock';
      label.textContent = 'mock data';
      banner.classList.remove('show');
      footerDot.style.background = 'var(--yellow)';
    } else if (ok) {
      badge.className = 'status-badge connected';
      label.textContent = 'connected';
      banner.classList.remove('show');
      footerDot.style.background = 'var(--green)';
    } else {
      badge.className = 'status-badge disconnected';
      label.textContent = 'disconnected';
      banner.classList.add('show');
      footerDot.style.background = 'var(--red)';
    }
  }

  // ====== MOCK DATA ======
  var mockDomainNames = [
    'concurrency', 'error_handling', 'testing', 'persistence', 'http_server',
    'cli', 'search', 'file_io', 'json_parsing', 'logging',
    'config', 'socket', 'parsing', 'crypto', 'regex',
    'authentication', 'monitoring', 'caching', 'validation', 'serialization',
    'networking', 'templates', 'middleware', 'database'
  ];

  var mockBigramNames = [
    'error:handling', 'file:read', 'test:assert', 'mutex:lock',
    'json:parse', 'http:server', 'search:index', 'domain:learning',
    'config:yaml', 'socket:listen', 'autotune:decay', 'batch:process',
    'token:count', 'cache:write', 'signal:handler', 'context:cancel',
    'goroutine:channel', 'struct:embed'
  ];

  var mockState = {
    promptCount: 142,
    domainHits: {},
    bigrams: {},
    cohitKw: {
      'login:auth': 12, 'session:session_mgmt': 7, 'queue:batch_processing': 15,
      'upload:storage_ops': 9, 'wrangler:cloudflare': 5, 'retry:resilience': 11,
      'scrape:content_capture': 8
    },
    cohitTd: {
      'auth:@authentication': 20, 'session_mgmt:@websocket': 14, 'batch_processing:@queue': 18,
      'storage_ops:@r2': 12, 'cloudflare:@cloudflare': 6, 'resilience:@resilience': 16
    },
    keywords: 312,
    terms: 145,
    fileHits: 156,
    idxFiles: 525,
    idxTokens: 48291
  };

  // Initialize mock domain hits
  mockDomainNames.forEach(function(n, i) {
    if (i < 6) mockState.domainHits[n] = 20 - i * 2;
    else if (i < 12) mockState.domainHits[n] = 8 - (i - 6);
    else if (i < 18) mockState.domainHits[n] = 2;
    else mockState.domainHits[n] = 0;
  });

  // Initialize mock bigrams
  mockBigramNames.forEach(function(n, i) {
    mockState.bigrams[n] = 50 - i * 2;
  });

  function mockTick() {
    if (Math.random() < 0.4) mockState.promptCount++;
    if (Math.random() < 0.3) {
      var di = Math.floor(Math.random() * 12);
      mockState.domainHits[mockDomainNames[di]] = (mockState.domainHits[mockDomainNames[di]] || 0) + 1;
    }
    if (Math.random() < 0.3) {
      var bkeys = Object.keys(mockState.bigrams);
      mockState.bigrams[bkeys[Math.floor(Math.random() * bkeys.length)]]++;
    }
    if (Math.random() < 0.2) {
      var ck = Object.keys(mockState.cohitKw);
      mockState.cohitKw[ck[Math.floor(Math.random() * ck.length)]]++;
    }
    if (Math.random() < 0.2) {
      var tk = Object.keys(mockState.cohitTd);
      mockState.cohitTd[tk[Math.floor(Math.random() * tk.length)]]++;
    }
    if (Math.random() < 0.15) mockState.keywords++;
    if (Math.random() < 0.1) mockState.terms++;
    if (Math.random() < 0.2) mockState.fileHits++;
  }

  function mockData() {
    mockTick();
    var s = mockState;
    var domains = mockDomainNames.map(function(n) {
      return { name: n, hits: s.domainHits[n] || 0, tier: (s.domainHits[n] || 0) >= 2 ? 'core' : 'context', state: 'active', source: 'search' };
    }).sort(function(a, b) { return b.hits - a.hits || a.name.localeCompare(b.name); });

    var coreCount = domains.filter(function(d) { return d.tier === 'core'; }).length;

    return {
      health: { status: 'ok', file_count: s.idxFiles, token_count: s.idxTokens, uptime: '1h23m' },
      stats: {
        prompt_count: s.promptCount,
        domain_count: domains.length,
        core_count: coreCount,
        context_count: domains.length - coreCount,
        keyword_count: s.keywords,
        term_count: s.terms,
        bigram_count: Object.keys(s.bigrams).length,
        file_hit_count: s.fileHits,
        index_files: s.idxFiles,
        index_tokens: s.idxTokens
      },
      domains: { domains: domains, count: domains.length, core_count: coreCount },
      bigrams: {
        bigrams: Object.assign({}, s.bigrams),
        count: Object.keys(s.bigrams).length,
        cohit_kw_term: Object.assign({}, s.cohitKw),
        cohit_term_domain: Object.assign({}, s.cohitTd),
        cohit_kw_count: Object.keys(s.cohitKw).length,
        cohit_td_count: Object.keys(s.cohitTd).length
      }
    };
  }

  // ====== DOMAIN RENDERING ======
  var prevDomainData = null;

  function renderDomains(domainsResult) {
    var list = domainsResult.domains || [];
    var container = document.getElementById('domainTableContainer');
    var placeholder = document.getElementById('domainPlaceholder');

    if (list.length === 0) {
      if (placeholder) placeholder.style.display = 'block';
      return;
    }
    if (placeholder) placeholder.style.display = 'none';

    // Check if structure changed
    var prevList = prevDomainData ? (prevDomainData.domains || []) : [];
    var structureChanged = !prevDomainData || list.length !== prevList.length;
    if (!structureChanged) {
      for (var i = 0; i < list.length; i++) {
        if (list[i].name !== prevList[i].name) {
          structureChanged = true;
          break;
        }
      }
    }

    var prevHitsMap = {};
    prevList.forEach(function(d) { prevHitsMap[d.name] = d.hits; });

    if (structureChanged) {
      // Full rebuild
      var html = '<table class="domain-table"><thead><tr>' +
        '<th>#</th><th>Domain</th><th style="text-align:right">Hits</th><th>Tier</th><th>State</th>' +
        '</tr></thead><tbody id="domainTbody">';
      list.forEach(function(d, idx) {
        var tierClass = d.tier === 'core' ? 'tier-core' : 'tier-ctx';
        var tierLabel = d.tier === 'core' ? 'core' : 'ctx';
        html += '<tr data-dname="' + esc(d.name) + '">' +
          '<td class="d-rank">' + (idx + 1) + '</td>' +
          '<td class="d-name">@' + esc(d.name) + '</td>' +
          '<td class="d-hits" data-dhits="' + esc(d.name) + '">' + d.hits.toFixed(1) + '</td>' +
          '<td class="d-tier"><span class="tier-pill ' + tierClass + '">' + tierLabel + '</span></td>' +
          '<td class="d-state">' + esc(d.state || '') + '</td>' +
          '</tr>';
      });
      html += '</tbody></table>';
      container.innerHTML = html;

      // Pulse changed rows
      list.forEach(function(d) {
        if (prevHitsMap[d.name] !== undefined && prevHitsMap[d.name] !== d.hits) {
          var row = container.querySelector('[data-dname="' + CSS.escape(d.name) + '"]');
          if (row) {
            var hitsCell = row.querySelector('.d-hits');
            if (hitsCell) { hitsCell.classList.remove('pulse'); void hitsCell.offsetWidth; hitsCell.classList.add('pulse'); }
          }
        }
      });
    } else {
      // Surgical update - only update changed hits
      list.forEach(function(d, idx) {
        var row = container.querySelector('[data-dname="' + CSS.escape(d.name) + '"]');
        if (!row) return;
        var hitsCell = row.querySelector('[data-dhits="' + CSS.escape(d.name) + '"]');
        if (hitsCell) {
          var newVal = d.hits.toFixed(1);
          if (hitsCell.textContent !== newVal) {
            hitsCell.textContent = newVal;
            hitsCell.classList.remove('pulse');
            void hitsCell.offsetWidth;
            hitsCell.classList.add('pulse');
          }
        }
        // Update tier
        var tierCell = row.querySelector('.d-tier .tier-pill');
        if (tierCell) {
          var tierClass = d.tier === 'core' ? 'tier-core' : 'tier-ctx';
          var tierLabel = d.tier === 'core' ? 'core' : 'ctx';
          tierCell.className = 'tier-pill ' + tierClass;
          tierCell.textContent = tierLabel;
        }
      });
    }

    prevDomainData = domainsResult;
  }

  // ====== BIGRAM RENDERING ======
  var prevBigramData = null;

  function renderBigrams(bigramsResult) {
    var bg = bigramsResult.bigrams || {};
    var ckw = bigramsResult.cohit_kw_term || {};
    var ctd = bigramsResult.cohit_term_domain || {};

    var container = document.getElementById('ngramContainer');
    var placeholder = document.getElementById('ngramPlaceholder');

    var bgKeys = Object.keys(bg);
    var ckwKeys = Object.keys(ckw);
    var ctdKeys = Object.keys(ctd);

    if (bgKeys.length === 0 && ckwKeys.length === 0 && ctdKeys.length === 0) {
      if (placeholder) placeholder.style.display = 'block';
      return;
    }
    if (placeholder) placeholder.style.display = 'none';

    var bgSorted = bgKeys.map(function(k) { return [k, bg[k]]; })
      .sort(function(a, b) { return b[1] - a[1]; }).slice(0, 10);
    var ckSorted = ckwKeys.map(function(k) { return [k, ckw[k]]; })
      .sort(function(a, b) { return b[1] - a[1]; }).slice(0, 8);
    var ctSorted = ctdKeys.map(function(k) { return [k, ctd[k]]; })
      .sort(function(a, b) { return b[1] - a[1]; }).slice(0, 8);

    // Build signature to detect structural changes
    var sig = bgSorted.map(function(e) { return e[0]; }).join(',') + '|' +
      ckSorted.map(function(e) { return e[0]; }).join(',') + '|' +
      ctSorted.map(function(e) { return e[0]; }).join(',');

    var prevSig = prevBigramData ? prevBigramData._sig : null;

    // Build previous value map for pulse detection
    var prevMap = {};
    if (prevBigramData) {
      var pb = prevBigramData.bigrams || {};
      var pck = prevBigramData.cohit_kw_term || {};
      var pct = prevBigramData.cohit_term_domain || {};
      Object.keys(pb).forEach(function(k) { prevMap['bg:' + k] = pb[k]; });
      Object.keys(pck).forEach(function(k) { prevMap['ck:' + k] = pck[k]; });
      Object.keys(pct).forEach(function(k) { prevMap['ct:' + k] = pct[k]; });
    }

    if (sig !== prevSig) {
      // Full rebuild
      var html = '';
      html += buildNgramSection('BIGRAMS', bgSorted, 'bar-cyan', 'bg', prevMap);
      if (ckSorted.length > 0) {
        html += buildNgramSection('COHITS: KW \u2192 TERM', ckSorted, 'bar-green', 'ck', prevMap);
      }
      if (ctSorted.length > 0) {
        html += buildNgramSection('COHITS: TERM \u2192 DOMAIN', ctSorted, 'bar-purple', 'ct', prevMap);
      }
      container.innerHTML = html;

      // Pulse changed values
      [bgSorted, ckSorted, ctSorted].forEach(function(sorted, si) {
        var prefix = ['bg', 'ck', 'ct'][si];
        sorted.forEach(function(pair) {
          var key = prefix + ':' + pair[0];
          if (prevMap[key] !== undefined && prevMap[key] !== pair[1]) {
            var el = container.querySelector('[data-ngkey="' + CSS.escape(key) + '"] .ngram-count');
            if (el) { el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse'); }
          }
        });
      });
    } else {
      // Surgical update
      [bgSorted, ckSorted, ctSorted].forEach(function(sorted, si) {
        var prefix = ['bg', 'ck', 'ct'][si];
        var maxVal = sorted.length > 0 ? sorted[0][1] : 1;
        sorted.forEach(function(pair) {
          var key = prefix + ':' + pair[0];
          var row = container.querySelector('[data-ngkey="' + CSS.escape(key) + '"]');
          if (!row) return;
          var cntEl = row.querySelector('.ngram-count');
          if (cntEl && cntEl.textContent !== String(pair[1])) {
            cntEl.textContent = pair[1];
            cntEl.classList.remove('pulse');
            void cntEl.offsetWidth;
            cntEl.classList.add('pulse');
          }
          var bar = row.querySelector('.ngram-bar-fill');
          if (bar) {
            bar.style.width = (pair[1] / maxVal * 100).toFixed(1) + '%';
          }
        });
      });
    }

    bigramsResult._sig = sig;
    prevBigramData = bigramsResult;
  }

  function buildNgramSection(title, sorted, barClass, prefix, prevMap) {
    var maxVal = sorted.length > 0 ? sorted[0][1] : 1;
    var html = '<div class="ngram-section">';
    html += '<div class="ngram-section-title">' + title + '</div>';
    sorted.forEach(function(pair) {
      var pct = (pair[1] / maxVal * 100).toFixed(1);
      var key = prefix + ':' + pair[0];
      html += '<div class="ngram-row" data-ngkey="' + esc(key) + '">' +
        '<span class="ngram-name">' + esc(pair[0]) + '</span>' +
        '<span class="ngram-bar-track"><span class="ngram-bar-fill ' + barClass + '" style="width:' + pct + '%"></span></span>' +
        '<span class="ngram-count">' + pair[1] + '</span>' +
        '</div>';
    });
    html += '</div>';
    return html;
  }

  // ====== ACTIVITY FEED (MOCK MODE) ======
  var activityRows = [];
  var activityStartTime = Date.now();
  var activityInitialized = false;

  var mockTargetsRead = [
    'internal/domain/learner/learner.go',
    'internal/adapters/bbolt/store.go',
    'internal/domain/index/engine.go',
    'cmd/aoa/main.go',
    'internal/app/app.go',
    'internal/ports/interfaces.go',
    'internal/adapters/socket/server.go',
    'internal/domain/enricher/atlas.go'
  ];

  var mockTargetsSearch = [
    'func.*Observe', 'SearchEngine', 'autotune', 'DomainMeta',
    'Bigrams', 'TokenRef', 'mutex.*lock', 'bbolt.*bucket'
  ];

  var mockTargetsLearn = [
    '@concurrency', '@error_handling', '@testing', '@persistence',
    '@http_server', '@search', '@file_io', '@logging'
  ];

  function initActivityFeed() {
    var body = document.getElementById('activityBody');
    var badge = document.getElementById('activityBadge');

    if (MOCK) {
      badge.className = 'badge badge-live';
      badge.textContent = 'live';
      body.innerHTML = '<table class="activity-table"><thead><tr>' +
        '<th>Action</th><th>Source</th><th>Impact</th><th>Target</th><th>Time</th>' +
        '</tr></thead><tbody id="activityTbody"></tbody></table>';
    } else {
      badge.className = 'badge badge-soon';
      badge.textContent = 'coming soon';
      body.innerHTML = '<div class="placeholder-msg">' +
        'Activity feed will show searches, guided reads, and impact in real-time. Requires backend ring buffer.' +
        '</div>';
    }
    activityInitialized = true;
  }

  function addMockActivity() {
    if (!MOCK) return;
    var tbody = document.getElementById('activityTbody');
    if (!tbody) return;

    var roll = Math.random();
    var action, pillClass, source, impact, impactClass, target;

    if (roll < 0.4) {
      action = 'Read';
      pillClass = 'pill-read';
      source = 'aoa-guided';
      var savings = [91, 92, 93, 94, 95, 96, 87, 89];
      impact = '\u2193 ' + savings[Math.floor(Math.random() * savings.length)] + '%';
      impactClass = 'impact-green';
      target = mockTargetsRead[Math.floor(Math.random() * mockTargetsRead.length)];
    } else if (roll < 0.75) {
      action = 'Search';
      pillClass = 'pill-search';
      source = Math.random() < 0.5 ? 'grep' : 'find';
      var hits = Math.floor(Math.random() * 40) + 1;
      impact = hits + ' hits';
      impactClass = 'impact-cyan';
      target = mockTargetsSearch[Math.floor(Math.random() * mockTargetsSearch.length)];
    } else {
      action = 'Learn';
      pillClass = 'pill-learn';
      source = Math.random() < 0.6 ? 'observe' : 'autotune';
      if (source === 'observe') {
        impact = '+' + (Math.floor(Math.random() * 5) + 1) + ' terms';
      } else {
        impact = 'cycle #' + (Math.floor(Math.random() * 20) + 1);
      }
      impactClass = 'impact-purple';
      target = mockTargetsLearn[Math.floor(Math.random() * mockTargetsLearn.length)];
    }

    var now = Date.now();
    activityRows.unshift({ action: action, pillClass: pillClass, source: source, impact: impact, impactClass: impactClass, target: target, time: now });

    // Cap at 15 rows
    if (activityRows.length > 15) {
      activityRows = activityRows.slice(0, 15);
    }

    // Rebuild table body
    var html = '';
    activityRows.forEach(function(row) {
      var elapsed = now - row.time;
      var timeStr;
      if (elapsed < 1000) timeStr = 'just now';
      else if (elapsed < 60000) timeStr = Math.floor(elapsed / 1000) + 's ago';
      else timeStr = Math.floor(elapsed / 60000) + 'm ago';

      html += '<tr>' +
        '<td><span class="action-pill ' + row.pillClass + '">' + row.action + '</span></td>' +
        '<td class="source-text">' + esc(row.source) + '</td>' +
        '<td class="impact-text ' + row.impactClass + '">' + esc(row.impact) + '</td>' +
        '<td class="target-text">' + esc(row.target) + '</td>' +
        '<td class="time-text">' + timeStr + '</td>' +
        '</tr>';
    });
    tbody.innerHTML = html;
  }

  // ====== APPLY DATA ======
  function applyData(health, stats, domains, bigrams) {
    // Overview hero
    set('h-prompts', stats.prompt_count.toLocaleString());
    set('h-domains', String(stats.domain_count));
    set('h-files', String(health.file_count));

    // Metrics panel
    set('m-prompts', stats.prompt_count.toLocaleString());
    set('m-domains', String(stats.domain_count));

    // Autotune
    var progress = stats.prompt_count % 50;
    var remaining = 50 - progress;
    set('at-num', String(progress));
    var fillEl = document.getElementById('at-fill');
    if (fillEl) fillEl.style.width = (progress / 50 * 100).toFixed(1) + '%';
    set('at-sub', 'next cycle in ' + remaining);

    // Uptime
    set('s-uptime', health.uptime || '\u2014');

    // Overview stats
    set('s-keywords', stats.keyword_count.toLocaleString());
    set('s-terms', String(stats.term_count));
    set('s-bigrams', String(stats.bigram_count));
    set('s-filehits', String(stats.file_hit_count));
    set('s-files', String(health.file_count));
    set('s-tokens', stats.index_tokens.toLocaleString());

    // Learning stats
    set('l-domains', String(stats.domain_count));
    set('l-core', String(stats.core_count));
    set('l-terms', String(stats.term_count));
    set('l-keywords', stats.keyword_count.toLocaleString());
    set('l-bigrams', String(stats.bigram_count));

    // Total hits computed from domains
    var totalHits = 0;
    (domains.domains || []).forEach(function(d) { totalHits += d.hits; });
    set('l-hits', totalHits.toFixed(0));

    // Dynamic rendering
    renderDomains(domains);
    renderBigrams(bigrams);
  }

  // ====== POLL LOOP ======
  async function poll() {
    if (!activityInitialized) initActivityFeed();

    if (MOCK) {
      var d = mockData();
      setConnected(true);
      applyData(d.health, d.stats, d.domains, d.bigrams);
      addMockActivity();
      setTimeout(poll, 1500);
      return;
    }

    try {
      var responses = await Promise.all([
        fetch('/api/health'),
        fetch('/api/stats'),
        fetch('/api/domains'),
        fetch('/api/bigrams')
      ]);
      for (var i = 0; i < responses.length; i++) {
        if (!responses[i].ok) throw new Error('HTTP ' + responses[i].status);
      }
      var data = await Promise.all(responses.map(function(r) { return r.json(); }));
      setConnected(true);
      retryDelay = 2000;
      applyData(data[0], data[1], data[2], data[3]);
    } catch (e) {
      setConnected(false);
      retryDelay = Math.min(retryDelay * 1.5, 10000);
    }

    setTimeout(poll, connected ? 2000 : retryDelay);
  }

  // ====== HELPERS ======
  function esc(s) {
    var d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  // ====== CLOCK ======
  function tickClock() {
    var el = document.getElementById('clock');
    if (el) el.textContent = new Date().toLocaleTimeString();
    setTimeout(tickClock, 1000);
  }
  tickClock();

  // ====== START ======
  if (MOCK) setConnected(true);
  poll();

})();
</script>
</body>
</html>
