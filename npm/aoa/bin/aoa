#!/usr/bin/env node
"use strict";

const { execFileSync } = require("child_process");
const fs = require("fs");
const os = require("os");
const path = require("path");

const PLATFORM_MAP = {
  "linux-x64": "@mvpscale/aoa-linux-x64",
  "linux-arm64": "@mvpscale/aoa-linux-arm64",
  "darwin-x64": "@mvpscale/aoa-darwin-x64",
  "darwin-arm64": "@mvpscale/aoa-darwin-arm64",
};

function getBinaryPath() {
  const key = `${os.platform()}-${os.arch()}`;
  const pkg = PLATFORM_MAP[key];

  if (!pkg) {
    console.error(`aoa: unsupported platform ${key}`);
    console.error(`Supported: ${Object.keys(PLATFORM_MAP).join(", ")}`);
    process.exit(1);
  }

  try {
    return require.resolve(`${pkg}/bin/aoa`);
  } catch (e) {}

  console.error(`aoa: platform package ${pkg} not installed.`);
  console.error("Try reinstalling: npm install @mvpscale/aoa");
  process.exit(1);
}

// Show setup message once on first run
const marker = path.join(os.homedir(), ".aoa", ".setup-shown");
if (!fs.existsSync(marker)) {
  const shimDir = path.join(os.homedir(), ".aoa", "shims");
  console.error("");
  console.error("  \x1b[36maOa installed.\x1b[0m Get started with: aoa init");
  console.error("");
  console.error("  To intercept AI tool searches, add to ~/.bashrc or ~/.zshrc:");
  console.error("");
  console.error(`    alias claude='PATH="${shimDir}:$PATH" claude'`);
  console.error(`    alias gemini='PATH="${shimDir}:$PATH" gemini'`);
  console.error("");
  try {
    fs.mkdirSync(path.join(os.homedir(), ".aoa"), { recursive: true });
    fs.writeFileSync(marker, new Date().toISOString() + "\n");
  } catch (_) {}
}

try {
  execFileSync(getBinaryPath(), process.argv.slice(2), {
    stdio: "inherit",
    env: process.env,
  });
} catch (e) {
  if (e && e.status) process.exit(e.status);
  throw e;
}
